#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

# fail fast
set -e

BPLOG_PREFIX="buildpack.java"

BP_DIR=$(cd $(dirname $0)/..; pwd) # absolute path
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

# shellcheck source=util/common.sh
source "$BP_DIR/bin/util/common.sh"
# shellcheck source=util/apt_dpkg_install.sh
source "$BP_DIR/bin/util/apt_dpkg_install.sh"

export_env_dir "$ENV_DIR"

### Local variable declaration
declare herokuos_version

# Get OS
herokuos_version="$(get_linux_platform_version)"

print "OS: Ubuntu $herokuos_version"
print "Stack version: ${STACK}"

print ".Net Core 3.1 on Ubuntu"
wget "https://packages.microsoft.com/config/ubuntu/$herokuos_version/packages-microsoft-prod.deb" -O packages-microsoft-prod.deb
sudo dpkg -i packages-microsoft-prod.deb
apt_install apt-transport-https dotnet-sdk-3.1

# Skip TELEMETRY_OPTOUT on production environment
export DOTNET_SKIP_FIRST_TIME_EXPERIENCE=${DOTNET_SKIP_FIRST_TIME_EXPERIENCE:-1}
export DOTNET_CLI_TELEMETRY_OPTOUT=${DOTNET_CLI_TELEMETRY_OPTOUT:-1}
export ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-production}

source $BP_DIR/lib/common.sh
source $BP_DIR/lib/maven.sh
source <(curl -s --retry 3 -L $BUILDPACK_STDLIB_URL)

export_env $ENV_DIR "." "JAVA_OPTS|JAVA_TOOL_OPTIONS"

install_jdk "${BUILD_DIR}" "${CACHE_DIR}"

[ -n "$(find ${BUILD_DIR} -type f -name "*.kt")" ] && mcount "kotlin.source"
[ -n "$(find ${BUILD_DIR} -type f -name "*.groovy")" ] && mcount "groovy.source"

run_mvn "install" $BUILD_DIR $CACHE_DIR
remove_mvn $BUILD_DIR $CACHE_DIR